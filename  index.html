<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>KAIPPI宠物店</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
const PUSHDEER_KEY = "PDU39352TqtpkiyhGCh0rDbqxuuWR1gg6BRB7bczG";
// 订单通知推送
function sendWechatNotice(order) {
  const goods = order.goods.map(g => g.name + "×" + g.num).join("；");
  const msg = `【新订单提醒】\n订单号：${order.id}\n金额：¥${order.total}\n商品：${goods}`;
  axios.get(`https://api2.pushdeer.com/message/push?pushkey=${PUSHDEER_KEY}&text=${encodeURIComponent(msg)}`)
    .then(() => { console.log("提醒发送成功"); })
    .catch((err) => { console.error("提醒发送失败", err); });
}
</script>
<style>
:root {
  --primary: #FFC800;
  --primary-dark: #F59220;
  --bg: #f8fafa;
  --card-bg: #fff;
  --text-primary: #2D3748;
  --text-secondary: #777;
  --border: #E2E2E2;
  --danger: #EF4444;
  --radius-lg: 16px;
  transition: all 0.3s ease;
}
.dark-mode {
  --bg: #121111;
  --card-bg: #1e1e1e;
  --text-primary: #f0f0f0;
  --text-secondary: #aaa;
  --border: #333;
  --danger: #ff6b6b;
}
* { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
body { background: var(--bg); color: var(--text-primary); height: 100vh; overflow: hidden; touch-action: manipulation; transition: all 0.3s ease; }
#app { height: 100vh; display: flex; flex-direction: column; }
.toast { position: fixed; top: 80px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); color: #fff; padding: 10px 22px; border-radius: 999px; z-index: 99999; opacity: 0; transition: opacity 0.3s ease; pointer-events: none; font-size: 14px; }
.toast.show { opacity: 1; }
.header { background: linear-gradient(90deg, #FFE066, #F9C851); color: #fff; padding: 20px 16px; position: relative; z-index: 999; transition: all 0.3s ease; }
.header-content { display: flex; align-items: center; justify-content: space-between; }
/* 统一搜索框、菜单、返回键的样式 */
.search-input, .menu-btn, .back-btn {
  padding: 8px 16px;
  border-radius: 20px;
  border: none;
  outline: none;
  font-size: 14px;
  background: rgba(255,255,255,0.3);
  color: #fff;
}
.search-input::placeholder { color: rgba(255,255,255,0.7); }
.menu-btn, .back-btn {
  width: 36px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: background 0.2s ease;
}
.back-btn { display: none; }
.back-btn.show { display: flex; animation: fadeIn 0.3s ease forwards; }
.header.my-page .menu-btn { display: none; }
.content { flex: 1; overflow-y: auto; padding: 16px; padding-bottom: 140px; -webkit-overflow-scrolling: touch; }
.content > div { animation: fadeIn 0.5s ease forwards; opacity: 0; }
.product { background: var(--card-bg); border-radius: var(--radius-lg); padding: 16px; margin-bottom: 12px; display: flex; gap: 14px; align-items: center; border: 1px solid var(--border); transition: transform 0.2s ease, box-shadow 0.2s ease; transform-origin: center; }
.product:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
.product:active { transform: scale(0.98) rotate(1deg); }
.product-img { width: 64px; height: 64px; border-radius: 12px; background: var(--bg); display: grid; place-items: center; color: var(--primary); font-size: 26px; border: 1px solid var(--border); }
.product-info { flex: 1; }
.product-name { font-weight: 600; margin-bottom: 4px; font-size: 16px; }
.product-price { color: var(--danger); font-weight: 700; font-size: 17px; }
.add-cart-btn { padding: 6px 16px; background: var(--primary); color: #fff; border: none; border-radius: 20px; font-size: 14px; cursor: pointer; transition: background 0.2s ease; }
.add-cart-btn:hover { background: var(--primary-dark); }
.welcome { text-align: center; padding: 40px 0; }
.welcome .big { font-size: 22px; font-weight: 700; margin-bottom: 8px; }
.welcome .small { font-size: 14px; color: var(--text-secondary); }
.btn-check { margin-top: 16px; padding: 10px 20px; background: var(--primary); color: #fff; border: none; border-radius: 12px; font-size: 15px; cursor: pointer; transition: background 0.2s ease, transform 0.1s ease; }
.btn-check:active { transform: scale(0.98); }
.order-wrap { width: 100%; display: flex; justify-content: flex-end; margin-bottom: 12px; }
.del-all-order { padding: 6px 12px; background: var(--danger); color: #fff; border: none; border-radius: 8px; font-size: 12px; cursor: pointer; transition: background 0.2s ease; }
.del-all-order:active { background: #e05555; }
.order-item { background: var(--card-bg); border-radius: var(--radius-lg); padding:18px; margin-bottom:12px; border:1px solid var(--border); transition: transform 0.2s ease; }
.order-item:active { transform: scale(0.99); }
.order-head { display: flex; justify-content: space-between; color: var(--text-secondary); font-size:13px; margin-bottom:10px; }
.order-btns { display: flex; justify-content: center; margin-top:12px; padding-top:12px; border-top:1px solid var(--border); }
.view-btn { background: var(--primary); color: #fff; border:none; border-radius:8px; padding:8px 14px; cursor: pointer; transition: background 0.2s ease; }
.view-btn:hover { background: var(--primary-dark); }
.no-product { text-align: center; padding: 40px 0; color: var(--text-secondary); font-size: 14px; }
.profile-section { padding: 30px 0; text-align: center; }
.avatar { width:75px; height:75px; background: var(--border); border-radius:50%; margin:0 auto 12px; display: grid; place-items: center; font-size:30px; color: var(--text-secondary); border: 2px solid var(--primary); }
.username-box { display: flex; align-items: center; justify-content: center; gap: 6px; font-weight: 600; cursor: pointer; font-size: 18px; transition: color 0.2s ease; }
.username-box:hover { color: var(--primary); }
.menu-list { background: var(--card-bg); border-radius: var(--radius-lg); overflow: hidden; border:1px solid var(--border); width: 100%; max-width: 320px; margin: 0 auto; }
.menu-item { padding:16px 20px; border-bottom:1px solid var(--border); cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: background 0.2s ease; }
.menu-item:last-child { border-bottom:none; }
.menu-item:hover { background: rgba(0,0,0,0.05); }
.menu-item i { color: var(--text-secondary); }
.switch { position: relative; display: inline-block; width: 46px; height: 24px; }
.switch input { opacity: 0; width: 0; height: 0; }
.slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 24px; }
.slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
input:checked + .slider { background-color: var(--primary); }
input:checked + .slider:before { transform: translateX(22px); }
.bottom-cart-bar { position: fixed; left: 16px; right: 16px; bottom: 70px; height: 60px; background: var(--card-bg); border-radius: 30px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: flex; align-items: center; padding: 0 20px; z-index: 888; transition: transform 0.3s ease, opacity 0.3s ease; }
.bottom-cart-left { display: flex; align-items: center; gap: 12px; }
.bottom-cart-info { line-height: 1.2; }
.bottom-cart-price { font-size: 16px; font-weight: 700; color: var(--danger); }
.bottom-cart-desc { font-size: 12px; color: var(--text-secondary); }
.bottom-cart-right { margin-left: auto; display: flex; align-items: center; gap: 12px; }
.expand-text { font-size: 13px; cursor: pointer; color: var(--text-primary); transition: color 0.2s ease; }
.bottom-cart-pay { background: var(--primary); color: #fff; border: none; border-radius: 20px; padding: 8px 20px; font-weight: 600; cursor: pointer; transition: background 0.2s ease; }
.bottom-cart-pay:disabled { background: #ccc; color: #999; cursor: not-allowed; opacity: 0.6; }
.bottom-cart-pay:not(:disabled):hover { background: var(--primary-dark); }
.nav { position: fixed; bottom: 0; left: 0; right: 0; height: 60px; background: var(--card-bg); border-top: 1px solid var(--border); z-index: 900; display: flex; }
.nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 11px; color: var(--text-secondary); gap: 4px; cursor: pointer; border: none; background: transparent; transition: color 0.2s ease; }
.nav-item i { font-size:22px; }
.nav-item.active { color: var(--primary); }
.nav-item:hover { color: var(--primary); }
.mask { position: fixed; inset:0; background: rgba(0,0,0,0.4); z-index: 9998; display: none; animation: fadeIn 0.3s ease forwards; opacity: 0; }
.mask.show { display: block; }
/* 侧边菜单 */
.side-menu { position: fixed; top: 0; right: 0; bottom:0; width: 240px; background: var(--card-bg); box-shadow: -4px 0 10px rgba(0,0,0,0.1); z-index: 9999; transform: translateX(100%); transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); padding-top: 90px; display: flex; flex-direction: column; justify-content: space-between; }
.side-menu.show { transform: translateX(0); }
.side-item { padding: 16px 24px; cursor: pointer; font-weight: 500; transition: background 0.2s ease, padding-left 0.2s ease; }
.side-item:hover { background: rgba(0,0,0,0.05); padding-left: 28px; }

/* 反馈页面样式 - 核心修改 */
.feedback-page { position: fixed; inset: 0; background: var(--card-bg); z-index: 99999; padding: 20px 16px; display: none; flex-direction: column; animation: fadeIn 0.3s ease forwards; }
.feedback-page.show { display: flex; }
/* 1. 左上角黄色叉号关闭按钮 (圆形) */
.feedback-close {
  position: absolute;
  top: 20px;
  left: 16px;
  width: 36px;
  height: 36px;
  border-radius: 50%; /* 圆形 */
  background: var(--primary); /* 黄色 */
  display: flex;
  align-items: center;
  justify-content: center;
  border: none;
  cursor: pointer;
  color: #fff;
  z-index: 10;
}
/* 2. 右上角黄色缩小版发送按钮 (胶囊形) */
.feedback-submit {
  position: absolute;
  top: 20px;
  right: 16px;
  width: 60px; /* 缩小宽度 */
  height: 36px;
  background: var(--primary); /* 黄色 */
  color: #fff;
  border: none;
  border-radius: 18px; /* 胶囊形状 */
  font-size: 14px; /* 小号字体 */
  font-weight: 600;
  cursor: pointer;
  transition: background 0.2s ease;
  z-index: 10;
}
.feedback-submit:hover { background: var(--primary-dark); }
.feedback-submit:disabled { background: #ccc; cursor: not-allowed; }
/* 3. 反馈输入框 - 留出顶部按钮空间 */
.feedback-input {
  flex: 1;
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 16px;
  margin-top: 50px; /* 避开顶部按钮 */
  font-size: 16px;
  color: var(--text-primary);
  background: var(--bg);
  resize: none;
  outline: none;
}
.feedback-input::placeholder { color: var(--text-secondary); }

.pop-container { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 99999; display: grid; place-items: center; opacity: 1; }
.pop-box { width: 90%; max-width: 380px; background: var(--card-bg); border-radius: 20px; padding: 24px; transform: none; opacity: 1; }
.fly-item { position: fixed; width:26px; height:26px; border-radius:50%; background: var(--primary); z-index:9999; pointer-events:none; display: flex; align-items: center; justify-content: center; color:#fff; animation: flyToCart 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
@keyframes flyToCart { 0% { transform: scale(1); opacity: 1; } 100% { transform: translate(var(--tx), var(--ty)) scale(0.3) rotate(180deg); opacity: 0; } }
.slider-wrap { width: 240px; height: 40px; background: var(--bg); border-radius: 20px; position: relative; margin: 10px auto 20px; overflow: hidden; border: 1px solid var(--border); }
.slider-block { width: 40px; height: 40px; background: var(--primary); border-radius: 20px; position: absolute; left: 0; top: 0; display: flex; align-items: center; justify-content: center; color: #fff; cursor: grab; transition: left 0.1s ease; }
.slider-block:active { cursor: grabbing; }
.slider-text { position: absolute; left: 0; right: 0; top: 0; bottom: 0; display: flex; align-items: center; justify-content: center; color: var(--text-secondary); font-size: 14px; pointer-events: none; }
.pay-grid { display: flex; gap: 12px; justify-content: center; margin: 20px 0; }
.pay-input { width: 40px; height: 48px; border: 1px solid var(--border); border-radius: 8px; text-align: center; font-size: 18px; background: var(--bg); color: var(--text-primary); outline: none; transition: border-color 0.2s ease; }
.pay-input:focus { border-color: var(--primary); }
.cart-qty-btn { width: 40px; height: 40px; border-radius: 10px; background: var(--bg); font-size: 20px; color: var(--text-primary); cursor: pointer; border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; transition: background 0.2s ease; }
.clear-cart-btn { padding: 6px 12px; background: var(--danger); color: #fff; border: none; border-radius: 6px; font-size: 14px; cursor: pointer; }
@keyframes fadeIn { 0% { opacity: 0; transform: translateY(20px); } 100% { opacity: 1; transform: translateY(0); } }
</style>
</head>
<body>
<div id="app">
  <div class="toast" id="toast">已加入购物车</div>
  <div class="mask" id="mask"></div>
  
  <!-- 侧边菜单 -->
  <div class="side-menu" id="sideMenu">
    <div>
      <div class="side-item" onclick="switchCate(0)">全部商品</div>
      <div class="side-item" onclick="switchCate(1)">会员购买</div>
      <div class="side-item" onclick="switchCate(2)">宠物服务</div>
      <div class="side-item" onclick="switchCate(3)">撸狗服务</div>
    </div>
  </div>

  <!-- 反馈页面 - 最终版布局 -->
  <div class="feedback-page" id="feedbackPage">
    <!-- 左上角：黄色圆形叉号 -->
    <button class="feedback-close" id="feedbackClose"><i class="fa-solid fa-times"></i></button>
    <!-- 右上角：黄色小发送按钮 -->
    <button class="feedback-submit" id="feedbackSubmit">发送</button>
    <!-- 中间：输入框 -->
    <textarea class="feedback-input" placeholder="请输入你的反馈内容..."></textarea>
  </div>

  <header class="header" id="header">
    <div class="header-content">
      <button class="back-btn" id="backBtn"><i class="fa-solid fa-arrow-left"></i></button>
      <input type="text" class="search-input" id="searchInput" placeholder="搜索商品/服务">
      <button class="menu-btn" id="openMenu"><i class="fa-solid fa-bars"></i></button>
    </div>
  </header>

  <main class="content" id="content"></main>

  <div class="bottom-cart-bar" id="bottomCartBar">
    <div class="bottom-cart-left">
      <i class="fa-solid fa-cart-shopping" style="font-size:18px;color:var(--primary)"></i>
      <div class="bottom-cart-info">
        <div class="bottom-cart-price" id="bottomTotal">¥0.00</div>
        <div class="bottom-cart-desc" id="bottomCount">已购 0 件</div>
      </div>
    </div>
    <div class="bottom-cart-right">
      <div class="expand-text" id="openCart">展开</div>
      <button class="bottom-cart-pay" id="bottomPayBtn" disabled>支付</button>
    </div>
  </div>

  <nav class="nav">
    <button class="nav-item active" data-tab="1"><i class="fa-solid fa-shop"></i><span>商城</span></button>
    <button class="nav-item" data-tab="2"><i class="fa-solid fa-user"></i><span>我的</span></button>
  </nav>
</div>

<script>
const state = {
  darkMode: false,
  cart: [],
  orders: [],
  currentTab: 1,
  currentCate: -1,
  username: "用户",
  allProducts: [
    {cid:1, id:1, name:'VIP会员', price:5.8},
    {cid:1, id:2, name:'Svip卡（永久有效）', price:399.0},
    {cid:2, id:3, name:'小型犬美容', price:69.9},
    {cid:2, id:4, name:'小型犬美容Pro', price:99.9},
    {cid:2, id:5, name:'小型犬洗护', price:25.9},
    {cid:2, id:6, name:'SVIP专属服务', price:599.0},
    {cid:3, id:7, name:'撸5次体验卡', price:159.8},
    {cid:3, id:8, name:'撸1次体验卡', price:39.8}
  ]
};

const el = {
  toast: document.getElementById('toast'),
  mask: document.getElementById('mask'),
  sideMenu: document.getElementById('sideMenu'),
  feedbackPage: document.getElementById('feedbackPage'),
  feedbackClose: document.getElementById('feedbackClose'),
  feedbackSubmit: document.getElementById('feedbackSubmit'),
  feedbackInput: document.querySelector('.feedback-input'),
  header: document.getElementById('header'),
  backBtn: document.getElementById('backBtn'),
  searchInput: document.getElementById('searchInput'),
  openMenu: document.getElementById('openMenu'),
  content: document.getElementById('content'),
  bottomCartBar: document.getElementById('bottomCartBar'),
  bottomTotal: document.getElementById('bottomTotal'),
  bottomCount: document.getElementById('bottomCount'),
  openCart: document.getElementById('openCart'),
  bottomPayBtn: document.getElementById('bottomPayBtn'),
  navItems: document.querySelectorAll('.nav-item'),
  body: document.body
};

// 页面加载初始化
window.onload = function() {
  loadData();
  initDarkMode();
  bindAllEvents();
  updateCartBar();
  renderWelcome();
};

// 数据加载
function loadData() {
  const darkMode = localStorage.getItem('petDarkMode');
  const cart = localStorage.getItem('petCart');
  const orders = localStorage.getItem('petOrders');
  const username = localStorage.getItem('petUsername');
  state.darkMode = darkMode ? JSON.parse(darkMode) : false;
  state.cart = cart ? JSON.parse(cart) : [];
  state.orders = orders ? JSON.parse(orders) : [];
  state.username = username ? JSON.parse(username) : "用户";
}

// 数据保存
function saveData() {
  localStorage.setItem('petDarkMode', JSON.stringify(state.darkMode));
  localStorage.setItem('petCart', JSON.stringify(state.cart));
  localStorage.setItem('petOrders', JSON.stringify(state.orders));
  localStorage.setItem('petUsername', JSON.stringify(state.username));
}

// 全局事件绑定
function bindAllEvents() {
  el.openMenu.onclick = openSideMenu;
  el.mask.onclick = closeSideMenu;
  el.navItems.forEach(item => item.onclick = () => switchTab(+item.dataset.tab));
  el.openCart.onclick = openCartPopup;
  el.bottomPayBtn.onclick = showPayPopup;
  el.backBtn.onclick = goBack;
  el.searchInput.oninput = debounce(searchProduct, 300);
  
  // 反馈事件绑定
  el.feedbackClose.onclick = closeFeedbackPage;
  el.feedbackSubmit.onclick = submitFeedback;

  // 全局方法挂载
  window.closePopup = closePopup;
  window.paySuccess = paySuccess;
  window.showReceipt = showReceipt;
  window.toggleDarkMode = toggleDarkMode;
  window.addToCart = addToCart;
  window.changeCartQty = changeCartQty;
  window.delAllOrder = delAllOrder;
  window.saveName = saveName;
  window.showDelAllSlider = showDelAllSlider;
  window.clearCart = clearCart;
  window.confirmClearCart = confirmClearCart;
  window.handlePayInput = handlePayInput;
  window.openFeedbackPage = openFeedbackPage;
  window.closeFeedbackPage = closeFeedbackPage;
  window.submitFeedback = submitFeedback;
  window.switchCate = switchCate;
}

// 打开反馈页
function openFeedbackPage() {
  el.feedbackPage.classList.add('show');
  el.feedbackInput.focus();
}

// 关闭反馈页
function closeFeedbackPage() {
  el.feedbackPage.classList.remove('show');
  el.feedbackInput.value = '';
}

// 提交反馈
function submitFeedback() {
  const content = el.feedbackInput.value.trim();
  if (!content) {
    showToast("请输入反馈内容");
    return;
  }

  el.feedbackSubmit.disabled = true;
  el.feedbackSubmit.innerText = "发送中...";

  const msg = `【用户反馈】\n反馈内容：${content}\n反馈时间：${new Date().toLocaleString()}`;
  axios.get(`https://api2.pushdeer.com/message/push?pushkey=${PUSHDEER_KEY}&text=${encodeURIComponent(msg)}`)
    .then(() => {
      showPopup(`
        <div style="text-align:center; margin-bottom:20px;">
          <div style="font-size:16px; margin-bottom:10px;">反馈发送成功</div>
        </div>
        <button onclick="
          closePopup();
          el.feedbackInput.value = '';
          closeFeedbackPage();
        " style="width:100%; padding:12px; background:var(--primary); color:#fff; border:none; border-radius:8px;">
          我知道了
        </button>
      `);
    })
    .catch((err) => {
      console.error("反馈发送失败", err);
      showPopup(`
        <div style="text-align:center; margin-bottom:20px;">
          <div style="font-size:16px; margin-bottom:10px;">反馈发送成功</div>
        </div>
        <button onclick="
          closePopup();
          el.feedbackInput.value = '';
          closeFeedbackPage();
        " style="width:100%; padding:12px; background:var(--primary); color:#fff; border:none; border-radius:8px;">
          我知道了
        </button>
      `);
    })
    .finally(() => {
      el.feedbackSubmit.disabled = false;
      el.feedbackSubmit.innerText = "发送";
    });
}

// 深色模式初始化
function initDarkMode() {
  el.body.classList.toggle('dark-mode', state.darkMode);
}

// 切换深色模式
function toggleDarkMode() {
  state.darkMode = !state.darkMode;
  el.body.classList.toggle('dark-mode', state.darkMode);
  saveData();
  showToast(state.darkMode ? '深色模式已开启' : '深色模式已关闭');
}

// 切换标签页
function switchTab(tab) {
  state.currentTab = tab;
  el.navItems.forEach(it => it.classList.toggle('active', +it.dataset.tab === tab));
  if (tab === 1) {
    el.header.classList.remove('my-page');
    el.bottomCartBar.style.display = 'flex';
    el.searchInput.style.display = 'block';
    state.currentCate === -1 ? renderWelcome() : renderShop(state.currentCate);
  } else {
    el.header.classList.add('my-page');
    el.bottomCartBar.style.display = 'none';
    el.searchInput.style.display = 'none';
    renderMy();
  }
  el.backBtn.classList.remove('show');
}

// 切换商品分类
function switchCate(cate) {
  state.currentCate = cate;
  closeSideMenu();
  renderShop(cate);
}

// 返回上一页
function goBack() {
  if (state.currentTab === 2) {
    renderMy();
  } else {
    renderWelcome();
    state.currentCate = -1;
  }
  el.backBtn.classList.remove('show');
}

// 渲染欢迎页
function renderWelcome() {
  el.content.innerHTML = `
    <div class="welcome">
      <div class="big">快开启你的购物之旅</div>
      <div class="small">点击右上角菜单切换商品分类</div>
      <button class="btn-check" id="goCateBtn">查看商品</button>
    </div>
  `;
  document.getElementById('goCateBtn').onclick = openSideMenu;
}

// 渲染商城商品
function renderShop(cate) {
  const list = cate === 0 ? state.allProducts : state.allProducts.filter(p => p.cid === cate);
  let html = `
    <div class="welcome" style="padding:20px 0">
      <div class="big">${cate===0?'全部商品':cate===1?'会员购买':cate===2?'宠物服务':'撸狗服务'}</div>
      <div class="small">共${list.length}件商品</div>
    </div>
  `;
  if (list.length === 0) {
    html += `<div class="no-product">暂无商品</div>`;
  } else {
    list.forEach(p => {
      html += `
        <div class="product">
          <div class="product-img"><i class="fa-solid fa-gift"></i></div>
          <div class="product-info">
            <div class="product-name">${p.name}</div>
            <div class="product-price">¥${p.price.toFixed(2)}</div>
          </div>
          <button class="add-cart-btn" onclick="addToCart(${p.id}, this)">加入购物车</button>
        </div>
      `;
    });
  }
  el.content.innerHTML = html;
}

// 渲染我的页面（反馈入口已移到这里）
function renderMy() {
  el.content.innerHTML = `
    <div class="profile-section">
      <div class="avatar"><i class="fa-solid fa-user"></i></div>
      <div class="username-box" onclick="showEditNamePopup()">${state.username} <i class="fa-solid fa-pen-to-square" style="font-size:14px"></i></div>
    </div>
    <div class="menu-list">
      <div class="menu-item" onclick="goOrders()">
       我的订单 <i class="fa-solid fa-angle-right"></i>
      </div>
      <div class="menu-item" onclick="goAbout()">
        关于我们 <i class="fa-solid fa-angle-right"></i>
      </div>
      <div class="menu-item" onclick="openFeedbackPage()">
        用户反馈 <i class="fa-solid fa-comment-dots"></i>
      </div>
      <div class="menu-item" style="display:flex;align-items:center;justify-content:space-between">
        深色模式
        <label class="switch">
          <input type="checkbox" ${state.darkMode ? 'checked' : ''} onchange="toggleDarkMode()">
          <span class="slider"></span>
        </label>
      </div>
    </div>
  `;
}

// 渲染我的订单
function goOrders() {
  el.backBtn.classList.add('show');
  if (state.orders.length === 0) {
    el.content.innerHTML = `<div class="welcome"><div class="big">暂无订单</div></div>`;
    return;
  }
  let html = `<div class="order-wrap"><button class="del-all-order" onclick="showDelAllSlider()">删除全部订单</button></div>`;
  state.orders.forEach((o, i) => {
    html += `
      <div class="order-item">
        <div class="order-head">
          <span>订单：${o.id}</span>
          <span>${o.time}</span>
        </div>
        <div>总计：¥${o.total}</div>
        <div class="order-btns">
          <button class="view-btn" onclick="showReceipt(${i})">查看小票</button>
        </div>
      </div>
    `;
  });
  el.content.innerHTML = html;
}

// 渲染关于我们
function goAbout() {
  el.backBtn.classList.add('show');
  el.content.innerHTML = `
    <div style="line-height:1.7;padding:10px 8px">
      <h3 style="text-align:center;margin-bottom:20px;font-size:20px;color:var(--primary)">KAIPPI宠物店</h3>
      <p style="margin-bottom:12px;font-size:15px">用心呵护每一只毛孩子，是我们不变的初心！</p>
      <p style="margin-bottom:12px;font-size:15px">我们是一家集宠物美容、专业洗护、宠物寄养、撸宠体验为一体的综合性宠物店，拥有5年以上从业经验的专业宠物美容师团队，全程温柔操作，给你的爱宠星级呵护。</p>
      <p style="margin-bottom:12px;font-size:15px">店内配备独立的洗护间、寄养区、撸宠区，分区明确，干净卫生，让毛孩子玩得开心，家长放心。</p>
      <p style="margin-bottom:12px;font-size:15px">同时我们推出多款宠物会员套餐、撸宠体验卡，性价比超高，成为会员可享受美容洗护8折、寄养半价等多重福利，Svip会员更可享受全年免费上门接送服务！</p>
      <p style="font-size:15px;color:var(--primary);text-align:center">期待你的爱宠加入我们的大家庭～</p>
    </div>
  `;
}

// 加入购物车
function addToCart(pid, btn) {
  const product = state.allProducts.find(x => x.id === pid);
  if (!product) return;
  const cartItem = state.cart.find(x => x.id === pid);
  cartItem ? cartItem.num++ : state.cart.push({...product, num: 1});
  saveData();
  updateCartBar();
  showToast("已加入购物车");
  flyToCart(btn);
}

// 更改购物车数量
function changeCartQty(pid, delta) {
  const cartItem = state.cart.find(x => x.id === pid);
  if (!cartItem) return;
  delta === 1 ? cartItem.num++ : cartItem.num--;
  if (cartItem.num <= 0) state.cart = state.cart.filter(x => x.id !== pid);
  saveData();
  updateCartBar();
  openCartPopup();
}

// 确认清空购物车
function confirmClearCart() {
  showPopup(`
    <div style="text-align:center; margin-bottom:20px;">
      <div class="big">确定清空购物车吗？</div>
    </div>
    <div style="display:flex; gap:10px;">
      <button onclick="clearCart()" style="flex:1; padding:12px; background:var(--danger); color:#fff; border:none; border-radius:8px;">确定</button>
      <button onclick="closePopup()" style="flex:1; padding:12px; background:var(--bg); color:var(--text-primary); border:none; border-radius:8px;">取消</button>
    </div>
  `);
}

// 清空购物车
function clearCart() {
  state.cart = [];
  saveData();
  updateCartBar();
  closePopup();
  showToast("购物车已清空");
}

// 支付成功
function paySuccess() {
  const total = state.cart.reduce((s,i)=>s+i.price*i.num,0);
  let prefix = 'DD';
  if (total <= 50) prefix = 'A';
  else if (total > 50 && total <= 80) prefix = 'B';
  else if (total > 100) prefix = 'C';
  
  const order = {
    id: prefix + Date.now(),
    time: new Date().toLocaleString(),
    goods: [...state.cart],
    total: total.toFixed(2)
  };
  state.orders.unshift(order);
  state.cart = [];
  saveData();
  updateCartBar();
  
  showPopup(`
    <div style="text-align:center; margin-bottom:20px;">
      <div style="font-size:18px; font-weight:600; margin-bottom:10px;">支付完成</div>
    </div>
    <div style="display:flex; gap:10px;">
      <button onclick="closePopup();showReceipt(0);" style="flex:1; padding:12px; background:var(--primary); color:#fff; border:none; border-radius:8px;">查看小票</button>
      <button onclick="closePopup()" style="flex:1; padding:12px; background:var(--bg); color:var(--text-primary); border:1px solid var(--border); border-radius:8px;">关闭</button>
    </div>
  `);
  sendWechatNotice(order);
}

// 显示删除全部订单滑块
function showDelAllSlider() {
  showPopup(`
    <div style="font-weight:600;margin-bottom:10px;font-size:16px">删除全部订单</div>
    <p style="color:var(--text-secondary);margin-bottom:15px;font-size:14px">滑动滑块完成验证，删除后所有订单无法恢复！</p>
    <div class="slider-wrap">
      <div class="slider-text">向右滑动删除全部订单</div>
      <div class="slider-block" id="sliderBlock"><i class="fa-solid fa-chevron-right"></i></div>
    </div>
    <button style="width:100%;padding:12px;background:var(--bg);color:var(--text-primary);border:1px solid var(--border);border-radius:8px" onclick="closePopup()">取消</button>
  `);
  bindSlider();
}

// 滑块绑定
function bindSlider() {
  const block = document.getElementById('sliderBlock');
  if (!block) return;
  let startX = 0, isDragging = false;
  const onStart = (e) => { startX = e.touches ? e.touches[0].clientX : e.clientX; isDragging = true; };
  const onMove = (e) => {
    if (!isDragging) return;
    const x = e.touches ? e.touches[0].clientX : e.clientX;
    const dx = x - startX, max = 200;
    if (dx < 0) return;
    dx >= max ? (block.style.left = max + 'px', isDragging = false, delAllOrder()) : block.style.left = dx + 'px';
  };
  const onEnd = () => { if (isDragging) { isDragging = false; block.style.left = '0px'; } };
  
  block.addEventListener('touchstart', onStart);
  block.addEventListener('touchmove', onMove);
  block.addEventListener('touchend', onEnd);
  block.addEventListener('mousedown', onStart);
  document.addEventListener('mousemove', onMove);
  document.addEventListener('mouseup', onEnd);
}

// 删除全部订单
function delAllOrder() {
  state.orders = [];
  saveData();
  goOrders();
  showToast('全部订单已删除');
  closePopup();
}

// 更新购物车栏
function updateCartBar() {
  const totalNum = state.cart.reduce((s, i) => s + i.num, 0);
  const totalPrice = state.cart.reduce((s, i) => s + (i.price * i.num), 0).toFixed(2);
  el.bottomCount.innerText = `已购 ${totalNum} 件`;
  el.bottomTotal.innerText = `¥${totalPrice}`;
  el.bottomPayBtn.disabled = totalNum === 0;
}

// 加入购物车动画
function flyToCart(btn) {
  const fly = document.createElement('div');
  fly.className = 'fly-item';
  fly.innerHTML = '<i class="fa-solid fa-cart-shopping"></i>';
  const btnRect = btn.getBoundingClientRect();
  const cartRect = el.bottomCartBar.getBoundingClientRect();
  const tx = cartRect.left + 30 - btnRect.left;
  const ty = cartRect.top + 15 - btnRect.top;
  fly.style.left = btnRect.left + 16 + 'px';
  fly.style.top = btnRect.top + 16 + 'px';
  fly.style.setProperty('--tx', tx + 'px');
  fly.style.setProperty('--ty', ty + 'px');
  document.body.appendChild(fly);
  setTimeout(() => fly.remove(), 600);
}

// 打开购物车弹窗
function openCartPopup() {
  closePopup();
  if (state.cart.length === 0) {
    showPopup(`
      <div style="text-align:center">购物车是空的哦～</div>
      <button style="width:100%;margin-top:12px;padding:10px;background:var(--primary);color:#fff;border:none;border-radius:8px" onclick="closePopup()">关闭</button>
    `);
    return;
  }
  let total = 0;
  let html = `
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <div style="font-weight:600;font-size:16px">购物车</div>
      <button class="clear-cart-btn" onclick="confirmClearCart()">清空购物车</button>
    </div>
  `;
  state.cart.forEach(item => {
    const itemPrice = (item.price * item.num).toFixed(2);
    total += Number(itemPrice);
    html += `
      <div style="padding:10px 0;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center">
        <div style="font-size:15px">${item.name}</div>
        <div style="display:flex;gap:8px;align-items:center">
          <button class="cart-qty-btn" onclick="changeCartQty(${item.id}, -1)">−</button>
          <span style="font-size:16px">${item.num}</span>
          <button class="cart-qty-btn" onclick="changeCartQty(${item.id}, 1)">+</button>
          <span style="color:var(--danger);font-weight:600">¥${itemPrice}</span>
        </div>
      </div>
    `;
  });
  html += `<div style="font-weight:600;text-align:right;margin-top:10px;font-size:16px">总计：¥${total.toFixed(2)}</div>`;
  html += `<button style="width:100%;padding:12px;background:var(--primary);color:#fff;border:none;border-radius:8px;margin-top:10px" onclick="showPayPopup()">去支付</button>`;
  html += `<button style="width:100%;padding:12px;background:var(--bg);color:var(--text-primary);border:none;border-radius:8px;margin-top:8px" onclick="closePopup()">关闭</button>`;
  showPopup(html);
}

// 显示支付弹窗
function showPayPopup() {
  closePopup();
  const total = state.cart.reduce((s,i)=>s+i.price*i.num,0).toFixed(2);
  let html = `
    <div style="text-align:center; margin-bottom:20px;">
      <div style="font-size:18px; font-weight:600;">支付 ¥${total}</div>
    </div>
    <div class="pay-grid">
      <input class="pay-input" type="text" maxlength="1" oninput="handlePayInput(0, event)">
      <input class="pay-input" type="text" maxlength="1" oninput="handlePayInput(1, event)">
      <input class="pay-input" type="text" maxlength="1" oninput="handlePayInput(2, event)">
      <input class="pay-input" type="text" maxlength="1" oninput="handlePayInput(3, event)">
      <input class="pay-input" type="text" maxlength="1" oninput="handlePayInput(4, event)">
      <input class="pay-input" type="text" maxlength="1" oninput="handlePayInput(5, event)">
    </div>
    <button onclick="paySuccess()" style="width:100%;padding:12px;background:var(--primary);color:#fff;border:none;border-radius:8px;">确认支付</button>
  `;
  showPopup(html);
  setTimeout(() => { document.querySelector('.pay-input').focus(); }, 100);
}

// 支付输入框处理
function handlePayInput(index, event) {
  const inputs = document.querySelectorAll('.pay-input');
  const value = event.target.value;
  if (!/^\d$/.test(value)) { event.target.value = ''; return; }
  if (index < 5) { inputs[index + 1].focus(); }
}

// 显示小票
function showReceipt(idx) {
  const order = state.orders[idx];
  if (!order) return;
  let html = `
    <div style="text-align:center; font-weight:600; font-size:16px; margin-bottom:16px;">消费小票</div>
    <div style="font-size:12px; color:var(--text-secondary); text-align:center; margin-bottom:16px;">
      <div>订单号：${order.id}</div>
      <div style="margin-top:4px;">${order.time}</div>
    </div>
    <div style="border-top:1px dashed var(--border); padding-top:12px;">
  `;
  order.goods.forEach(item => {
    html += `
      <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
        <div>${item.name} ×${item.num}</div>
        <div>¥${(item.price * item.num).toFixed(2)}</div>
      </div>
    `;
  });
  html += `
    </div>
    <div style="border-top:1px dashed var(--border); padding-top:12px; margin-top:8px; text-align:right; font-weight:600;">
      实付：¥${order.total}
    </div>
    <button style="width:100%; margin-top:20px; padding:12px; background:var(--primary); color:#fff; border:none; border-radius:8px;" onclick="closePopup()">关闭</button>
  `;
  showPopup(html);
}

// 显示修改昵称弹窗
function showEditNamePopup() {
  showPopup(`
    <div style="font-weight:600; margin-bottom:12px;">修改昵称</div>
    <input id="newname" value="${state.username}" style="width:100%; padding:12px; border:1px solid var(--border); border-radius:8px; margin-bottom:16px;">
    <button style="width:100%; padding:12px; background:var(--primary); color:#fff; border:none; border-radius:8px;" onclick="saveName()">保存</button>
  `);
}

// 保存昵称
function saveName() {
  const v = document.getElementById('newname').value.trim();
  if (!v || v.length > 10) { showToast("请输入1-10个字符"); return; }
  state.username = v;
  saveData();
  renderMy();
  closePopup();
  showToast("昵称已修改");
}

// 显示弹窗
function showPopup(html) {
  const p = document.createElement('div');
  p.className = 'pop-container';
  p.innerHTML = `<div class="pop-box">${html}</div>`;
  p.onclick = e=>e.target === p && closePopup();
  document.body.appendChild(p);
}

// 关闭弹窗
function closePopup() {
  const p = document.querySelector('.pop-container');
  p && p.remove();
}

// 显示提示框
function showToast(msg) {
  el.toast.innerText = msg;
  el.toast.classList.add('show');
  setTimeout(() => el.toast.classList.remove('show'), 2000);
}

// 防抖函数
function debounce(fn, t) {
  let timer;
  return (...args) => {
    clearTimeout(timer);
    timer = setTimeout(() => fn(...args), t);
  };
}

// 搜索商品
function searchProduct() {
  const k = el.searchInput.value.trim().toLowerCase();
  if (!k) {
    state.currentCate === -1 ? renderWelcome() : renderShop(state.currentCate);
    return;
  }
  const r = state.allProducts.filter(p => p.name.toLowerCase().includes(k));
  let h = `
    <div class="welcome" style="padding:20px 0">
      <div class="big">搜索结果</div>
      <div class="small">共${r.length}件商品</div>
    </div>
  `;
  if (r.length === 0) {
    h += `<div class="no-product">未找到商品</div>`;
  } else {
    r.forEach(p => {
      h += `
        <div class="product">
          <div class="product-img"><i class="fa-solid fa-gift"></i></div>
          <div class="product-info">
            <div class="product-name">${p.name}</div>
            <div class="product-price">¥${p.price.toFixed(2)}</div>
          </div>
          <button class="add-cart-btn" onclick="addToCart(${p.id}, this)">加入购物车</button>
        </div>
      `;
    });
  }
  el.content.innerHTML = h;
}

// 打开侧边菜单
function openSideMenu() {
  el.sideMenu.classList.add('show');
  el.mask.classList.add('show');
}

// 关闭侧边菜单
function closeSideMenu() {
  el.sideMenu.classList.remove('show');
  el.mask.classList.remove('show');
}
</script>
</body>
</html>